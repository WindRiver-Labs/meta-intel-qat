From 120efad1c8c3d01883973c5e8242fdbb8d98f484 Mon Sep 17 00:00:00 2001
From: Yongxin Liu <yongxin.liu@windriver.com>
Date: Mon, 6 Jan 2020 09:26:39 +0800
Subject: [PATCH] qat: Link driver with object files instead of archived files

Due to mainline kernel commit 69ea912fda7 ("kbuild: remove unneeded
link_multi_deps"), modules cannot link *.a archives. So change .a to
.o files.

Upstream-Status: Inappropriate [Temporary workaround for kernel later than
v4.19-rc3]

Signed-off-by: Yongxin Liu <yongxin.liu@windriver.com>
---
 quickassist/Makefile                            | 2 ++
 quickassist/lookaside/access_layer/src/Makefile | 3 +--
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/quickassist/Makefile b/quickassist/Makefile
index f1f3cdccc033..2a5f665cb4c2 100644
--- a/quickassist/Makefile
+++ b/quickassist/Makefile
@@ -155,6 +155,7 @@ libosal_kernel: clean output_dir lac_lib_dir
 	echo ; echo 'Copying OSAL library';
 	cp $(OSAL_PATH)/src/linux/kernel_space/build/linux_2.6/kernel_space/libosal.a $(ICP_BUILD_OUTPUT)/libosal_kernel.a;
 	cp $(OSAL_PATH)/src/linux/kernel_space/build/linux_2.6/kernel_space/libosal.a $(LAC_LIB_DIR)/;
+	cp $(OSAL_PATH)/src/linux/kernel_space/build/linux_2.6/kernel_space/*.o $(LAC_LIB_DIR)/;
 
 
 #build linux qat_direct layer
@@ -170,6 +171,7 @@ qat_kernel: clean output_dir lac_lib_dir libosal_kernel cmn_ko
 	echo ; echo 'Copying qat_kernel library';
 	cp $(KERNEL_PATH)/src/build/linux_2.6/kernel_space/libadf_kernel.a $(ICP_BUILD_OUTPUT)/;
 	cp $(KERNEL_PATH)/src/build/linux_2.6/kernel_space/libadf_kernel.a $(LAC_LIB_DIR)/;
+	cp $(KERNEL_PATH)/src/build/linux_2.6/kernel_space/*.o $(LAC_LIB_DIR)/;
 
 
 lac_user: clean output_dir qat_direct libosal_user cmn_user
diff --git a/quickassist/lookaside/access_layer/src/Makefile b/quickassist/lookaside/access_layer/src/Makefile
index bf3e2447b87c..77043f4cdc1a 100644
--- a/quickassist/lookaside/access_layer/src/Makefile
+++ b/quickassist/lookaside/access_layer/src/Makefile
@@ -143,8 +143,7 @@ endif
 endif
 
 ifeq ($(ICP_OS_LEVEL), kernel_space)
-    ADDITIONAL_OBJECTS =  ../build/libs/libadf_kernel.a
-    ADDITIONAL_OBJECTS += ../build/libs/libosal.a
+    ADDITIONAL_OBJECTS += ../build/libs/libadf_kernel.a ../build/libs/libosal.a
 endif
 
 ifeq ($(ICP_OS_LEVEL), user_space)
-- 
2.17.1

